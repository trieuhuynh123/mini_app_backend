<!--
 ~ Copyright 2022 youngmonkeys.org
 ~ 
 ~ Licensed under the ezyplatform, Version 1.0.0 (the "License");
 ~ you may not use this file except in compliance with the License.
 ~ You may obtain a copy of the License at
 ~ 
 ~     https://youngmonkeys.org/licenses/ezyplatform-1.0.0.txt
 ~ 
 ~ Unless required by applicable law or agreed to in writing, software
 ~ distributed under the License is distributed on an "AS IS" BASIS,
 ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ~ See the License for the specific language governing permissions and
 ~ limitations under the License.
-->

<!DOCTYPE html>
<html
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{ezyadmin}">

<body>
<div layout:fragment="content" class="row">
    <div class="col-12 table-responsive">
        <table id="backupList" class="table bg-white vertical-align-middle">
            <thead>
            <tr>
                <th style="width: 10px">#</th>
                <th style="width: 25%;">[[#{version}]]</th>
                <th>[[#{files}]]</th>
                <th class="white-space-nowrap" style="width: 15%">[[#{actions}]]</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="backup, iterator : ${backups}">
                <td class="text-center">
                    [[${iterator.index + 1}]]
                </td>
                <td>
                    [[${backup.versionName}]]
                </td>
                <td>
                    <button type="button" class="btn btn-link pl-0" data-toggle="collapse" aria-expanded="false"
                            th:attr="data-target=|#collapse-backup-files-${iterator.index}|,aria-controls=|collapse-backup-files-${iterator.index}|">
                        [[#{show}]]/[[#{hide}]]
                    </button>
                    <ul class="collapse p-0 m-0" th:id="${'collapse-backup-files-' + iterator.index}">
                        <li th:each="file, fileIterator : ${backup.files}" class="line-break-anywhere">
                            [[${file.getRelativePath()}]]
                        </li>
                    </ul>
                </td>
                <td>
                    <a class="text-info pr-2 cursor-pointer"
                       data-toggle="tooltip" data-placement="top" title="Recover"
                       th:if="${adminRoles.isAccessible('/api/v1/platform/backups/{versionName}/recover', 'POST')}"
                       th:attr="onclick=|ezyadmin.onRecoverBackupButton('${backup.versionName}')|">
                        <i class="fas fa-undo"></i>
                    </a>
                    <a class="text-danger cursor-pointer"
                       data-toggle="tooltip" data-placement="top" title="Delete"
                       th:if="${adminRoles.isAccessible('/api/v1/platform/backups/{versionName}', 'DELETE')}"
                       th:attr="onclick=|ezyadmin.onDeleteBackupButton('${backup.versionName}')|">
                        <i class="fas fa-trash"></i>
                    </a>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="col-12 mb-3"></div>
</div>
<th:block layout:fragment="modals">
<th:block th:replace="~{fragments/prompt :: content(id='recover-backup-modal', title=confirm, confirmButton=confirm, closeButton=close)}" />
<th:block th:replace="~{fragments/prompt :: content(id='delete-backup-modal', title=confirm, confirmButton=delete, closeButton=close)}" />
</th:block>
<script layout:fragment="scripts" th:inline="javascript">
/*<![CDATA[*/
ezyadmin.messages.recover_backup_version = /*[[#{recover_backup_version}]]*/;
ezyadmin.messages.delete_backup_version = /*[[#{delete_backup_version}]]*/;
/*]]>*/

ezyadmin.onRecoverButtonClick = function() {
    ezyadmin.installEzyPlatform();
}

ezyadmin.onPromptConfirmed = function(modalId) {
    if (modalId == 'delete-backup-modal') {
        ezyadmin.deleteBackup();
    } else if (modalId == 'recover-backup-modal') {
        ezyadmin.recoverBackup();
    }
}

// ================== recover backup ================
ezyadmin.onRecoverBackupButton = function(versionName) {
    ezyadmin.selectedBackupVersion = versionName;
    $('#recover-backup-modal-body-content').text(
        ezyadmin.messages.recover_backup_version.replace('{0}', versionName) + '?'
    );
    $('#recover-backup-modal').modal('show');
}

ezyadmin.recoverBackup = function() {
    $.ajax({
        type: 'POST',
        url: '/api/v1/platform/backups/' + ezyadmin.selectedBackupVersion + '/recover',
        success: function () {
            location.reload();
        },
        error: function (data, e) {
            ezyadmin.processUpdateApiErrors({}, data);
            $('#recover-backup-modal').modal('hide');
        }
    });
}
// ================== delete backup ================
ezyadmin.onDeleteBackupButton = function(versionName) {
    ezyadmin.selectedBackupVersion = versionName;
    $('#delete-backup-modal-body-content').text(
        ezyadmin.messages.delete_backup_version.replace('{0}', versionName) + '?'
    );
    $('#delete-backup-modal').modal('show');
}

ezyadmin.deleteBackup = function() {
    $.ajax({
        type: 'DELETE',
        url: '/api/v1/platform/backups/' + ezyadmin.selectedBackupVersion,
        success: function () {
            location.reload();
        },
        error: function (data, e) {
            ezyadmin.processUpdateApiErrors({}, data);
            $('#delete-backup-modal').modal('hide');
        }
    });
}

ezyadmin.createDataTable('backupList');
</script>
<th:block layout:fragment="post-scripts">
<script th:replace="~{ezyplatform/scripts :: scripts}" />
</th:block>
</body>
</html>
