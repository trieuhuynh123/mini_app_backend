<!--
 ~ Copyright 2022 youngmonkeys.org
 ~
 ~ Licensed under the ezyplatform, Version 1.0.0 (the "License");
 ~ you may not use this file except in compliance with the License.
 ~ You may obtain a copy of the License at
 ~
 ~     https://youngmonkeys.org/licenses/ezyplatform-1.0.0.txt
 ~
 ~ Unless required by applicable law or agreed to in writing, software
 ~ distributed under the License is distributed on an "AS IS" BASIS,
 ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ~ See the License for the specific language governing permissions and
 ~ limitations under the License.
-->

<!DOCTYPE html>
<html
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{ezyadmin}">
<head>
    <script>
        var ecommerce = {};
    </script>
</head>
<body>
<div layout:fragment="content" class="row">
    <div class="col-lg-3 col-md-0 col-0"></div>
    <div class="col-lg-3 col-md-4 col-12 page-search">
        <label for="orderSearchShoppingCartId" class="text-nowrap">[[#{search}]]: </label>
        <input type="text" id="orderSearchKeyword"
               class="form-control" th:placeholder="#{keyword}"
               onkeydown="ecommerce.onKeydownToSearchOrder();">
    </div>
    <div class="col-lg-3 col-md-4 col-12 page-search">
        <label for="orderSearchShoppingCartId" class="text-nowrap">[[#{shopping_cart_id}]]: </label>
        <input type="number" id="orderSearchShoppingCartId"
               class="form-control" th:placeholder="#{shopping_cart_id}"
               onkeydown="ecommerce.onKeydownToSearchOrder();">
    </div>
    <div class="col-lg-3 col-md-4 col-12 page-search">
        <label for="orderSearchStatus" class="text-nowrap">[[#{status}]]: </label>
        <select class="form-control form-select" id="orderSearchStatus"
                onchange="ecommerce.onOrderSearchStatusChanged();">
            <option value="">[[#{all}]]</option>
            <option th:each="orderStatus : ${orderStatuses}"
                    th:value="${orderStatus}"
                    th:selected="${orderStatus.toString() == orderSearchStatus}">
                [[#{${orderStatus.toString().toLowerCase()}}]]
            </option>
        </select>
    </div>
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body table-responsive p-0">
                <table class="table table-bordered table-hover text-nowrap align-middle-cells">
                    <thead>
                    <tr>
                        <th class="text-center pl-2p5">[[#{id}]]</th>
                        <th>[[#{first_product}]]</th>
                        <th>[[#{creator}]]</th>
                        <th>[[#{approver}]]</th>
                        <th class="text-center">[[#{total_products}]]</th>
                        <th>[[#{total_money}]]</th>
                        <th class="text-center">[[#{payment_service}]]</th>
                        <th class="text-center">[[#{status}]]</th>
                        <th class="text-center">[[#{created_at}]]</th>
                        <th class="text-center">[[#{actions}]]</th>
                    </tr>
                    </thead>
                    <tbody id="orderListBody">
                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
            <div class="card-footer clearfix">
                <span><span id="orderCountText">0</span>
                    [[${#strings.toLowerCase(#messages.msg('of'))}]]
                    <span id="totalOrderText">0</span>
                    [[${#strings.toLowerCase(#messages.msg('orders'))}]]
                </span>
                <ul class="pagination pagination-sm m-0 float-right">
                    <li class="page-item">
                        <a class="page-link cursor-pointer" id="firstPageButton">
                            <i class="fas fa-arrow-circle-left pl-1 pr-1"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link cursor-pointer" id="prevPageButton">[[#{prev}]]</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link cursor-pointer" id="nextPageButton">[[#{next}]]</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link cursor-pointer" id="lastPageButton">
                            <i class="fas fa-arrow-circle-right pl-1 pr-1"></i>
                        </a>
                    </li>
                </ul>
            </div>
            <!-- /.card-footer -->
        </div>
    </div>
</div>
<th:block layout:fragment="modals">
    <th:block th:replace="~{fragments/prompt :: content(id='approve-order-modal', title=confirm, confirmButton=approve, closeButton=close)}" />
    <th:block th:replace="~{fragments/prompt :: content(id='reject-order-modal', title=confirm, confirmButton=reject, closeButton=close, type=delete)}" />
</th:block>
<script layout:fragment="scripts" th:inline="javascript">
/*<![CDATA[*/
ecommerce.orderSearchStatus = /*[[${orderSearchStatus}]]*/ '';
ezyadmin.messages.paid = /*[[#{paid}]]*/ '';
ezyadmin.messages.payment_error = /*[[#{payment_error}]]*/ '';
ezyadmin.messages.rejected = /*[[#{rejected}]]*/ '';
ezyadmin.messages.unpaid = /*[[#{unpaid}]]*/ '';
ezyadmin.messages.waiting_for_confirmation=/*[[#{waiting_for_confirmation}]]*/ '';
ezyadmin.messages.waiting_for_payment=/*[[#{waiting_for_payment}]]*/ '';
/*]]>*/

ecommerce.changeBrowserUrl = function() {
    var params = [];
    if (ecommerce.orderSearchStatus) {
        params.push('status=' + ecommerce.orderSearchStatus);
    }
    if (ezyadmin.lang) {
        params.push('lang=' + ezyadmin.lang);
    }
    var url = '/ecommerce/orders';
    if (params.length) {
        url += '?' + params.join('&');
    }
    window.history.pushState({}, '', url);
}

// ========== order search =============
ecommerce.onKeydownToSearchOrder = function() {
    if(event.key === 'Enter') {
        ecommerce.orderSearchKeyword = $('#orderSearchKeyword').val();
        ecommerce.orderSearchShoppingCartId = $('#orderSearchShoppingCartId').val();
        ecommerce.fetchOrderList();
    }
}

ecommerce.onOrderSearchStatusChanged = function() {
    ecommerce.orderSearchStatus = $('#orderSearchStatus').val();
    ecommerce.changeBrowserUrl();
    ecommerce.fetchOrderList();
}

// ========== order pagination =============
$('#firstPageButton').click(() => {
    ecommerce.fetchOrderList('first');
});
$('#lastPageButton').click(() => {
    ecommerce.fetchOrderList('last');
});
$('#nextPageButton').click(() => {
    ecommerce.fetchOrderList('next');
});
$('#prevPageButton').click(() => {
    ecommerce.fetchOrderList('prev');
});

// ========== order list =============
ecommerce.fetchOrderList = function(action) {
    var queryString = '';
    if (ecommerce.orderSearchStatus) {
        queryString += '&status=' + ecommerce.orderSearchStatus;
    }
    if (ecommerce.orderSearchKeyword) {
        queryString += '&keyword=' + ecommerce.orderSearchKeyword;
    }
    if (ecommerce.orderSearchShoppingCartId) {
        queryString += '&shoppingCartId=' + ecommerce.orderSearchShoppingCartId;
    }
    if (action == 'current') {
        if (ecommerce.lastOrderQueryString) {
            queryString = ecommerce.lastOrderQueryString;
        }
    } else if (action == 'next') {
        if (ecommerce.lastOrderPageToken.next) {
            queryString += '&nextPageToken=' + ecommerce.lastOrderPageToken.next;
        } else {
            return;
        }
    } else if (action == 'prev') {
        if (ecommerce.lastOrderPageToken.prev) {
            queryString += '&prevPageToken=' + ecommerce.lastOrderPageToken.prev;
        } else {
            return;
        }
    } else if (action == 'last') {
        queryString += '&lastPage=true';
    }
    $.ajax({
        url: '/ecommerce/api/v1/orders?limit=12' + queryString,
        type: 'GET',
        dataType: 'json'
    })
    .done(function(data) {
        $('#orderCountText').text(data.count);
        $('#totalOrderText').text(ezyadmin.formatNumberWithCommas(data.total));
        ecommerce.lastOrderQueryString = queryString;
        ecommerce.lastOrderPageToken = data.pageToken;
        $('#orderListBody').html(ecommerce.buildOrderListBodyHtml(data.items));
        if (data.continuation.hasNext) {
            $('#nextPageButton').removeClass('text-secondary');
        } else {
            $('#nextPageButton').addClass('text-secondary');
        }
        if (data.continuation.hasPrevious) {
            $('#prevPageButton').removeClass('text-secondary');
        } else {
            $('#prevPageButton').addClass('text-secondary');
        }
    })
    .fail(function(e) {
    	ezyadmin.processGetApiErrors(e);
    });
}
ecommerce.buildOrderListBodyHtml = function(orders) {
    var html = '';
    orders.forEach((order) => {
        html += ecommerce.buildOrderListItemHtml(order);
    });
    return html;
}
ecommerce.buildOrderListItemHtml = function(order) {
    var statusColor = ezyadmin.getTextColorByStatus(order.status);
    var html = `
        <tr id="order-row-${order.id}">
            <td class="text-center pl-2p5">
                <a href="/ecommerce/orders/${order.id}${ezyadmin.lang ? `?lang=${ezyadmin.lang}` : ''}">${order.id}</a>
            </td>
            <td>
                ${order.firstProduct ? `
                    ${order.firstProduct.iconImageUrl ? `<img src="${order.firstProduct.iconImageUrl}" width="64" class="object-fit-cover">` : ''}
                    <a href="/ecommerce/products/${order.firstProduct.id}${ezyadmin.lang ? `?lang=${ezyadmin.lang}` : ''}" class="ml-1">
                        ${order.firstProduct.productName}
                    </a>
                ` : ''}
            </td>
            <td>
                ${
                    order.creatorUser ? `
                        <a href="/users/${order.creatorUser.username}${ezyadmin.lang ? `?lang=${ezyadmin.lang}` : ''}">
                            ${order.creatorUser.name}
                        </a>
                    ` : order.creatorAdmin ? `
                        <a href="/users/${order.creatorAdmin.username}${ezyadmin.lang ? `?lang=${ezyadmin.lang}` : ''}">
                            ${order.creatorAdmin.name}
                        </a>
                    ` : ''
                }
            </td>
            <td>
                ${order.approverAdmin ? `
                    <a href="/admins/${order.approverAdmin.username}${ezyadmin.lang ? `?lang=${ezyadmin.lang}` : ''}">
                        ${order.approverAdmin.name}
                    </a>
                ` : ''}
            </td>
            <td class="text-center">${ezyadmin.formatNumberWithCommas(order.totalProducts)}</td>
            <td>${order.formattedTotalAmountMoney} ${order.currency.isoCode}</td>
            <td class="text-center">
                ${order.paymentServiceCode === 'UNKNOWN' ? order.paymentServiceCode : `
                    <a href="/ecommerce/payment-services/${order.paymentServiceCode}">
                        ${order.paymentServiceCode}
                    </a>
                `}
            </td>
            <td class="text-center ${statusColor}">${ezyadmin.getI18nMessage(order.status.toLowerCase())}</td>
            <td class="text-center">${ezyadmin.formatTimeStamp(order.createdAt)}</td>
            <td class="text-center">
                <a class="btn pr-1" href="/ecommerce/orders/${order.id}${ezyadmin.lang ? `?lang=${ezyadmin.lang}` : ''}">
                    <i class="fas fa-eye text-primary"></i>
                </a>
                ${order.status !== 'UNPAID' ? `
                    <button type="button" class="btn pl-1 pr-1" onclick="ecommerce.onApproveOrderClick(${order.id}, 'UNPAID');">
                        <i class="fas fa-check text-info"></i>
                    </button>
                ` : ''}
                ${order.status !== 'PAID' ? `
                    <button type="button" class="btn pl-1 pr-1" onclick="ecommerce.onApproveOrderClick(${order.id}, 'PAID');">
                        <i class="fas fa-check-circle text-success"></i>
                    </button>
                ` : ''}
                ${order.status !== 'REJECTED' ? `
                    <button type="button" class="btn pl-1" onclick="ecommerce.onRejectOrderClick(${order.id});">
                        <i class="fas fa-times-circle text-danger"></i>
                    </button>
                ` : ''}
            </td>
        </tr>`;
	return html;
}
ecommerce.fetchOrderList();
</script>
<th:block layout:fragment="post-scripts">
    <script th:replace="~{ecommerce/order/scripts :: actions}" />
</th:block>
</body>
</html>
