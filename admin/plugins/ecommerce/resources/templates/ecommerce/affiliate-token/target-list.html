<!--
 ~ Copyright 2022 youngmonkeys.org
 ~
 ~ Licensed under the ezyplatform, Version 1.0.0 (the "License");
 ~ you may not use this file except in compliance with the License.
 ~ You may obtain a copy of the License at
 ~
 ~     https://youngmonkeys.org/licenses/ezyplatform-1.0.0.txt
 ~
 ~ Unless required by applicable law or agreed to in writing, software
 ~ distributed under the License is distributed on an "AS IS" BASIS,
 ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ~ See the License for the specific language governing permissions and
 ~ limitations under the License.
-->

<!DOCTYPE html>
<html
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{ezyadmin}">
<body>
<th:block th:fragment="content">
    <div class="col-lg-9 col-md-7 col-0"></div>
    <div class="col-lg-3 col-md-5 col-12 page-search">
        <label for="targetSearchKeyword" class="text-nowrap">[[#{search}]]: </label>
        <input type="search" class="form-control" th:placeholder="#{keyword}" id="targetSearchKeyword"
               onkeydown="ecommerce.onKeydownToSearchTarget();">
    </div>
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body table-responsive p-0">
                <table class="table table-bordered table-hover text-nowrap align-middle-cells">
                    <thead>
                    <tr>
                        <th>[[#{id}]]</th>
                        <th>[[#{user}]]</th>
                        <th>[[#{product}]]</th>
                        <th>[[#{product_category}]]</th>
                        <th class="text-center">[[#{actions}]]</th>
                    </tr>
                    </thead>
                    <tbody id="targetListBody">
                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
            <div class="card-footer clearfix">
                <span><span id="targetCountText">0</span>
                    [[${#strings.toLowerCase(#messages.msg('of'))}]]
                    <span id="totalTargetText">0</span>
                    [[${#strings.toLowerCase(#messages.msg('targets'))}]]
                </span>
                <ul class="pagination pagination-sm m-0 float-right">
                    <li class="page-item">
                        <a class="page-link cursor-pointer" id="targetFirstPageButton">
                            <i class="fas fa-arrow-circle-left pl-1 pr-1"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link cursor-pointer" id="targetPrevPageButton">[[#{prev}]]</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link cursor-pointer" id="targetNextPageButton">[[#{next}]]</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link cursor-pointer" id="targetLastPageButton">
                            <i class="fas fa-arrow-circle-right pl-1 pr-1"></i>
                        </a>
                    </li>
                </ul>
            </div>
            <!-- /.card-footer -->
        </div>
    </div>
</th:block>
<script th:fragment="scripts" th:inline="javascript">
/*<![CDATA[*/
ezyadmin.messages.all = /*[[#{all}]]*/ '';
ezyadmin.messages.do_you_want_to_delete_target_pid = /*[[#{do_you_want_to_delete_target_pid}]]*/ '';
/*]]>*/

// ========== delete search =============
ecommerce.onDeleteAffiliateTokenTargetInAffiliateTokenClick = function(targetId) {
    ecommerce.selectedAffiliateTokenTargetId = targetId;
    $('#delete-target-modal-body-content')
        .text(
            ezyadmin
                .messages
                .do_you_want_to_delete_target_pid
                .replace('{0}', targetId)
        );
    $('#delete-target-modal').modal('show');
}

ecommerce.deleteAffiliateTokenTarget = function() {
    $.ajax({
        type: 'DELETE',
        url: '/ecommerce/api/v1/affiliate-token-targets/' + ecommerce.selectedAffiliateTokenTargetId,
        success: function () {
            $('#delete-target-modal').modal('hide');
            if (ecommerce.fetchTargetList) {
                ecommerce.fetchTargetList('current');
            } else if (ecommerce.onAffiliateTokenTargetDeleted) {
                ecommerce.onAffiliateTokenTargetDeleted();
            } else {
                location.reload();
            }
        },
        error: function (data, e) {
            ezyadmin.processUpdateApiErrors({}, data);
        }
    });
}

ezyadmin.onPromptConfirmed = function(modalId) {
    if (modalId == 'delete-target-modal') {
        ecommerce.deleteAffiliateTokenTarget();
    }
}

// ========== target search =============
ecommerce.onKeydownToSearchTarget = function() {
    if(event.key === 'Enter') {
        ecommerce.doSearchTarget();
    }
}
ecommerce.doSearchTarget = function() {
    ecommerce.targetSearchKeyword = $('#targetSearchKeyword').val();
    ecommerce.fetchTargetList();
}

// ========== target pagination =============
$('#targetFirstPageButton').click(() => {
    ecommerce.fetchTargetList('first');
});
$('#targetLastPageButton').click(() => {
    ecommerce.fetchTargetList('last');
});
$('#targetNextPageButton').click(() => {
    ecommerce.fetchTargetList('next');
});
$('#targetPrevPageButton').click(() => {
    ecommerce.fetchTargetList('prev');
});

// ========== target list =============
ecommerce.fetchTargetList = function(action) {
    var queryString = '';
    if (ecommerce.targetSearchKeyword) {
        queryString += '&keyword=' + ecommerce.targetSearchKeyword;
    }
    if (action == 'next') {
        if (ecommerce.lastTargetPageToken.next) {
            queryString += '&nextPageToken=' + ecommerce.lastTargetPageToken.next;
        } else {
            return;
        }
    } else if (action == 'prev') {
        if (ecommerce.lastTargetPageToken.prev) {
            queryString += '&prevPageToken=' + ecommerce.lastTargetPageToken.prev;
        } else {
            return;
        }
    } else if (action == 'last') {
        queryString += '&lastPage=true';
    }
    $.ajax({
        url: '/ecommerce/api/v1/affiliate-tokens/' + ecommerce.selectedAffiliateTokenId +
             '/targets?limit=12' + queryString,
        type: 'GET',
        dataType: 'json'
    })
    .done(function(data) {
        $('#targetCountText').text(data.count);
        $('#totalTargetText').text(ezyadmin.formatNumberWithCommas(data.total));
        ecommerce.lastTargetPageToken = data.pageToken;
        $('#targetListBody').html(ecommerce.buildTargetListBodyHtml(data.items));
        if (data.continuation.hasNext) {
            $('#targetNextPageButton').removeClass('text-secondary');
        } else {
            $('#targetNextPageButton').addClass('text-secondary');
        }
        if (data.continuation.hasPrevious) {
            $('#targetPrevPageButton').removeClass('text-secondary');
        } else {
            $('#targetPrevPageButton').addClass('text-secondary');
        }
    })
    .fail(function(e) {
    	ezyadmin.processGetApiErrors(e);
    });
}

ecommerce.buildTargetListBodyHtml = function(targets) {
    var html = '';
    targets.forEach((target) => {
        html += ecommerce.buildTargetListItemHtml(target);
    });
    return html;
}
ecommerce.buildTargetListItemHtml = function(target) {
    var html = `
        <tr id="target-row-${target.id}">
            <td>${target.id}</td>
            <td>
                ${
                    target.forUser
                        ? `<a href="/users/${target.forUser.username}${ezyadmin.lang ? `?lang=${ezyadmin.lang}` : ''}">
                                ${target.forUser.name}
                            </a>`
                        : ezyadmin.messages.all
                }
            </td>
            <td>
                ${
                    target.forProduct
                        ? `<a href="/ecommerce/products/${target.forProduct.id}${ezyadmin.lang ? `?lang=${ezyadmin.lang}` : ''}">
                                ${target.forProduct.productName}
                            </a>`
                        : ezyadmin.messages.all
                }
            </td>
            <td>
                ${
                    target.forProductCategory
                        ? `<a href="/ecommerce/product-categories/${target.forProductCategory.id}${ezyadmin.lang ? `?lang=${ezyadmin.lang}` : ''}">
                                ${target.forProductCategory.displayName}
                            </a>`
                        : ezyadmin.messages.all
                }
            </td>
            <td class="text-center">
                <button type="button" class="btn pl-1" onclick="ecommerce.onDeleteAffiliateTokenTargetInAffiliateTokenClick(${target.id});">
                    <i class="fas fa-trash text-danger"></i>
                </button>
            </td>
        </tr>
    `;
	return html;
}
ecommerce.fetchTargetList();
</script>
</body>
</html>
