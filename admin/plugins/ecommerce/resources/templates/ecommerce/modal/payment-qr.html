<!--
 ~ Copyright 2022 youngmonkeys.org
 ~ 
 ~ Licensed under the ezyplatform, Version 1.0.0 (the "License");
 ~ you may not use this file except in compliance with the License.
 ~ You may obtain a copy of the License at
 ~ 
 ~     https://youngmonkeys.org/licenses/ezyplatform-1.0.0.txt
 ~ 
 ~ Unless required by applicable law or agreed to in writing, software
 ~ distributed under the License is distributed on an "AS IS" BASIS,
 ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ~ See the License for the specific language governing permissions and
 ~ limitations under the License.
-->

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="content" class="modal fade pt-4rem" id="payment-qr-modal">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">[[#{payment_qr}]]</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
               <div id="payment-qr-modal-content"
                    class="d-flex flex-column align-items-center p-3">
                   <div id="payment-qr-modal-qrcode"></div>
                   <div class="mt-3 font-weight-bold" id="payment-qr-modal-amount"></div>
                   <div class="text-center" id="payment-qr-modal-account"></div>
               </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" data-dismiss="modal">
                    [[#{cancel}]]
                </button>
                <button class="btn btn-primary" onclick="ecommerce.downloadPaymentQrCode();">
                    [[#{download}]]
                </button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<th:block th:fragment="scripts">
<script src="/ecommerce/js/qrcode.min.js"></script>
<script src="/ecommerce/js/html2canvas.min.js"></script>
<script th:inline="javascript">
/*<![CDATA[*/
ezyadmin.messages.account_number = /*[[#{account_number}]]*/ '';
ezyadmin.messages.account_owner_name = /*[[#{account_owner_name}]]*/ '';
ezyadmin.messages.bank = /*[[#{bank}]]*/ '';
ezyadmin.messages.bank_branch = /*[[#{bank_branch}]]*/ '';
/*]]>*/

ecommerce.showPaymentQrModal = function(data) {
    $('#payment-qr-modal-amount').text(data.amountIncludeIsoCode);
    var accountInformation = [
        `${ezyadmin.messages.account_number}: ${data.accountNumber}`,
        `${ezyadmin.messages.account_owner_name}: ${data.accountOwnerName}`,
        `${ezyadmin.messages.bank}: ${data.bankName}`
    ].join(', ');
    accountInformation +=
        `, ${ezyadmin.messages.bank_branch}: ${data.bankBranch}`;
    $('#payment-qr-modal-account').text(accountInformation);
    $('#payment-qr-modal-qrcode').empty();
    qrCode = new QRCode(document.getElementById("payment-qr-modal-qrcode"), {
        text: data.qrCode,
        width: 150,
        height: 150,
        colorDark : "#27004B",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.L
    });
    $('#payment-qr-modal').modal('show');
}

ecommerce.downloadPaymentQrCode = function() {
    ezyadmin.showLoadingScreen();
    var now = moment().format('YYYY_MM_DD_HH_mm_ss');
    html2canvas(document.querySelector("#payment-qr-modal-content"))
        .then(canvas => {
            const link = document.createElement('a');
            link.download = `payment_qr_${now}.png`;
            link.href = canvas.toDataURL();
            link.click();
            ezyadmin.hideLoadingScreen();
        });
}
</script>
</th:block>
</body>
</html>
